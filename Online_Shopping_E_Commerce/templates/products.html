{% extends "layout.html" %}

{% block head %}
{{ super() }}
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ItemList",
  "itemListElement": [
    {% for p in items %}
    {"@type": "ListItem", "position": {{ loop.index }}, "url": "{{ url_for('product_detail', pid=p.id, _external=True) }}"}{% if not loop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>
{% if GA4_ID %}
<script>
  (function(){
    function buildItems(){
      var els = document.querySelectorAll('a.group[data-pid]');
      var out = [];
      for (var i=0;i<els.length;i++){
        var el = els[i];
        out.push({
          item_id: el.getAttribute('data-pid'),
          item_name: el.getAttribute('data-name'),
          item_category: el.getAttribute('data-category'),
          price: Number(el.getAttribute('data-price')),
          currency: 'KES'
        });
      }
      return out;
    }
    function init(){
      var itemsData = buildItems();
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
      gtag('event', 'view_item_list', { item_list_name: 'Products', items: itemsData });
      var addLinks = document.querySelectorAll('a[href*="/cart/add/"]');
      for (var j=0;j<addLinks.length;j++){
        addLinks[j].addEventListener('click', function(){
          var pid = this.href.split('/').pop();
          gtag('event', 'add_to_cart', { currency: 'KES', value: 0, items: [{ item_id: pid }] });
        });
      }
      {% if META_PIXEL_ID %}
      if (window.fbq) { fbq('track', 'ViewContent'); }
      {% endif %}
    }
    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else { init(); }
  })();
</script>
{% endif %}
{% endblock %}

{% block content %}
<section class="py-8">
  <div class="container mx-auto px-4">
    <h1 class="text-2xl font-semibold text-gray-800 mb-6">Products</h1>

    <form method="get" action="{{ url_for('products') }}" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <input type="search" name="q" value="{{ q }}" placeholder="Search products" class="md:col-span-2 px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-300">
      <select name="cat" class="px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-300">
        <option value="">All Categories</option>
        {% for c in categories %}
        <option value="{{ c }}" {% if cat==c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
      <select name="sort" class="px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-300">
        <option value="new" {% if sort=='new' %}selected{% endif %}>Newest</option>
        <option value="price_asc" {% if sort=='price_asc' %}selected{% endif %}>Price: Low to High</option>
        <option value="price_desc" {% if sort=='price_desc' %}selected{% endif %}>Price: High to Low</option>
        <option value="rating" {% if sort=='rating' %}selected{% endif %}>Top Rated</option>
      </select>
      <div class="md:col-span-4 flex gap-2">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Apply</button>
        <a href="{{ url_for('products') }}" class="px-4 py-2 rounded-lg border">Reset</a>
      </div>
    </form>

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
      {% for p in items %}
      <a href="{{ url_for('product_detail', pid=p.id) }}" class="group bg-white rounded-lg overflow-hidden border hover:shadow-md transition" data-pid="{{ p.id }}" data-name="{{ p.name }}" data-category="{{ p.category }}" data-price="{{ '%.0f'|format(p.price) }}">
        <div class="h-44 bg-gray-100"></div>
        <div class="p-4">
          <div class="text-gray-800 font-medium group-hover:text-blue-700">{{ p.name }}</div>
          <div class="flex items-center justify-between mt-2">
            <div class="text-blue-600 font-semibold">{{ p.price|kes }}</div>
            <div class="text-sm text-gray-500">‚≠ê {{ '%.1f'|format(p.rating) }}</div>
          </div>
          <a href="{{ url_for('cart_add', pid=p.id) }}" class="mt-3 block w-full text-center bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Add to Cart</a>
        </div>
      </a>
      {% else %}
      <div class="col-span-full text-gray-600">No products found.</div>
      {% endfor %}
    </div>
  </div>
</section>
{% endblock %}
