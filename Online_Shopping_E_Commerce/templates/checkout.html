{% extends "layout.html" %}

{% block content %}
<section class="py-8">
  <div class="container mx-auto px-4">
    <h1 class="text-2xl font-semibold text-gray-800 mb-6">Checkout</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Customer details -->
      <form method="post" class="lg:col-span-2 space-y-4">
        <div class="bg-white border rounded-lg p-4">
          <h2 class="font-semibold text-gray-800 mb-4">Contact & Address</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">Full Name</label>
              <input name="name" value="{{ form.name }}" class="w-full px-4 py-2 rounded-lg border" required>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Phone (+254…)</label>
              <input name="phone" value="{{ form.phone }}" class="w-full px-4 py-2 rounded-lg border" required>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">County</label>
              <select name="county" class="w-full px-4 py-2 rounded-lg border">
                {% for c in counties %}
                <option value="{{ c }}" {% if form.county==c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Address</label>
              <input name="address" value="{{ form.address }}" placeholder="Estate/Road/House No." class="w-full px-4 py-2 rounded-lg border">
            </div>
          </div>
        </div>

        <div class="bg-white border rounded-lg p-4">
          <h2 class="font-semibold text-gray-800 mb-4">Delivery & Payment</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">Delivery Option</label>
              <select name="delivery" class="w-full px-4 py-2 rounded-lg border">
                <option value="standard" {% if form.delivery=='standard' %}selected{% endif %}>Standard Courier</option>
                <option value="same_day" {% if form.delivery=='same_day' %}selected{% endif %}>Same-day (Nairobi)</option>
                <option value="pickup" {% if form.delivery=='pickup' %}selected{% endif %}>Pickup Point</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Payment Method</label>
              <select name="payment" class="w-full px-4 py-2 rounded-lg border">
                <option value="mpesa" {% if form.payment=='mpesa' %}selected{% endif %}>M-Pesa (STK Push)</option>
                <option value="cod" {% if form.payment=='cod' %}selected{% endif %}>Cash on Delivery</option>
              </select>
            </div>
          </div>
        </div>

        <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">Place Order</button>
      </form>

      <!-- Summary -->
      <div>
        <div class="bg-white border rounded-lg p-4">
          <h2 class="font-semibold text-gray-800 mb-3">Order Summary</h2>
          <div class="space-y-3">
            {% for row in items %}
            <div class="flex justify-between text-gray-700">
              <span>{{ row.product.name }} × {{ row.qty }}</span>
              <span>{{ row.line_total|kes }}</span>
            </div>
            {% endfor %}
            <div class="border-t pt-3 text-gray-700 flex justify-between">
              <span>Subtotal</span><span>{{ subtotal|kes }}</span>
            </div>
            <div class="text-gray-700 flex justify-between">
              <span>Shipping</span><span>{{ shipping|kes }}</span>
            </div>
            <div class="border-t pt-3 font-semibold text-gray-900 flex justify-between">
              <span>Total</span><span>{{ total|kes }}</span>
            </div>
          </div>
          <a href="{{ url_for('cart') }}" class="block mt-4 text-center border px-4 py-2 rounded">Back to Cart</a>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% if GA4_ID %}
{% block scripts %}
{{ super() }}
<script>
  (function(){
    function buildItems(){
      var rows = document.querySelectorAll('.bg-white.border.rounded-lg.p-4 .flex.justify-between.text-gray-700');
      var out = [];
      // Fallback: build from server-rendered order summary rows above (limited info available)
      var names = document.querySelectorAll('.bg-white.border.rounded-lg.p-4 .flex.justify-between.text-gray-700 span:first-child');
      for (var i=0;i<names.length;i++){
        var nameText = names[i].textContent || '';
        out.push({ item_name: nameText.trim(), currency: 'KES' });
      }
      return out;
    }
    function init(){
      var items = buildItems();
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
      gtag('event', 'begin_checkout', { currency: 'KES', items: items });
    }
    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else { init(); }
  })();
</script>
{% endblock %}
{% endif %}
