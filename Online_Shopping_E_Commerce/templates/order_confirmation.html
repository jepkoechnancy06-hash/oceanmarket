{% extends "layout.html" %}

{% block content %}
<section class="py-8">
  <div class="container mx-auto px-4">
    <div class="bg-white border rounded-lg p-6 max-w-3xl mx-auto">
      <h1 class="text-2xl font-semibold text-green-700">Thank you! Your order is confirmed.</h1>
      <p class="text-gray-600 mt-2">We've received your order and sent a confirmation message.</p>

      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h2 class="font-medium text-gray-800 mb-2">Order</h2>
          <div class="text-gray-700">Order No: <span class="font-medium">{{ order.order_number }}</span></div>
          <div class="text-gray-700">Status: <span class="font-medium capitalize">{{ order.status }}</span></div>
          <div class="text-gray-700">Payment Ref: <span class="font-medium">{{ order.payment_ref }}</span></div>
        </div>
        <div>
          <h2 class="font-medium text-gray-800 mb-2">Delivery</h2>
          <div class="text-gray-700">Name: {{ order.name }}</div>
          <div class="text-gray-700">Phone: {{ order.phone }}</div>
          <div class="text-gray-700">County: {{ order.county }}</div>
          <div class="text-gray-700">Address: {{ order.address }}</div>
          <div class="text-gray-700">Option: {{ order.delivery|replace('_',' ')|title }}</div>
        </div>
      </div>

      <div class="mt-6">
        <h2 class="font-medium text-gray-800 mb-2">Items</h2>
        <div class="divide-y">
          {% for row in order.items %}
          <div class="py-3 flex justify-between text-gray-700">
            <span>{{ row.product.name }} Ã— {{ row.qty }}</span>
            <span>{{ row.line_total|kes }}</span>
          </div>
          {% endfor %}
        </div>
        <div class="mt-4 border-t pt-3 space-y-1 text-gray-800">
          <div class="flex justify-between"><span>Subtotal</span><span>{{ order.subtotal|kes }}</span></div>
          <div class="flex justify-between"><span>Shipping</span><span>{{ order.shipping|kes }}</span></div>
          <div class="flex justify-between font-semibold text-gray-900"><span>Total</span><span>{{ order.total|kes }}</span></div>
        </div>
      </div>

      <div class="mt-6 flex gap-3">
        <a href="{{ url_for('products') }}" class="px-5 py-2 rounded-lg border">Continue Shopping</a>
        <a href="{{ url_for('home') }}" class="px-5 py-2 rounded-lg bg-blue-600 text-white">Go to Home</a>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% if GA4_ID and order %}
{% block scripts %}
{{ super() }}
<script>
  (function(){
    var items = [
      {% for row in order.items %}
      {{ {'item_name': row.product.name, 'quantity': row.qty, 'price': row.product.price, 'currency': 'KES'} | tojson }}{% if not loop.last %},{% endif %}
      {% endfor %}
    ];
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
    gtag('event', 'purchase', {
      transaction_id: {{ order.order_number|tojson }},
      value: {{ order.total }},
      currency: 'KES',
      shipping: {{ order.shipping }},
      items: items
    });
    {% if META_PIXEL_ID %}
    if (window.fbq) { fbq('track', 'Purchase', { value: {{ order.total }}, currency: 'KES' }); }
    {% endif %}
  })();
</script>
{% endblock %}
{% endif %}
